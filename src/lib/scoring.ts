export type ScaleCode = 'ID'|'AT'|'CT'|'AM'|'HM'|'TU';

export type Answers = Record<
  `${ScaleCode}${1|2|3|4}`,
  number | string | undefined
>;

export interface TestResult {
  scores: {
    ID: number;
    AT: number;
    CT: number;
    AM: number;
    HM: number;
    TU: number;
  };
  tensions: {
    T1: number;
    T2: number;
  };
  archetypes: string[];
  descriptions: string[];
  archetypeData?: Archetype;
}

export interface Question {
  id: number;
  text: string;
  scale: ScaleCode;
  questionKey: `${ScaleCode}${1|2|3|4}`;
}

export const questions: Question[] = [
  // ID - Самовыражение
  { id: 1, text: "Когда я смотрю на свой дом, я хочу узнавать в нём себя.", scale: 'ID', questionKey: 'ID1' },
  { id: 2, text: "Мне важно видеть дома мои увлечения и ценности (книги, искусство, хобби).", scale: 'ID', questionKey: 'ID2' },
  { id: 3, text: "Мне комфортнее в пространстве, которое отличается от базовых типовых решений.", scale: 'ID', questionKey: 'ID3' },
  { id: 4, text: "Я хочу, чтобы люди, приходя ко мне, узнавали меня через мой дом.", scale: 'ID', questionKey: 'ID4' },
  
  // AT - Личные вещи и память
  { id: 5, text: "Без любимых вещей (фото, текстиль, предметы памяти) мне сложнее почувствовать место своим.", scale: 'AT', questionKey: 'AT1' },
  { id: 6, text: "Я сохраняю связь с прошлыми домами и местами жительства, и ценю ощущение постоянства.", scale: 'AT', questionKey: 'AT2' },
  { id: 7, text: "Важные для меня предметы помогают чувствовать себя спокойнее и устойчивее.", scale: 'AT', questionKey: 'AT3' },
  { id: 8, text: "Частая смена жилья для меня эмоционально непроста.", scale: 'AT', questionKey: 'AT4' },
  
  // CT - Порядок и структура
  { id: 9, text: "Я лучше отдыхаю, когда дома порядок и всё организовано.", scale: 'CT', questionKey: 'CT1' },
  { id: 10, text: "Мне важно распределять пространство и вещи так, чтобы всё имело своё место.", scale: 'CT', questionKey: 'CT2' },
  { id: 11, text: "Мне трудно, когда дома хаос и я не могу предсказать, что где находится.", scale: 'CT', questionKey: 'CT3' },
  { id: 12, text: "Я чаще выбираю практичные решения для дома, даже если они менее декоративные.", scale: 'CT', questionKey: 'CT4' },
  
  // AM - Лёгкость перемен
  { id: 13, text: "Я быстро осваиваюсь в новом жилье и делаю его «своим».", scale: 'AM', questionKey: 'AM1' },
  { id: 14, text: "Могу чувствовать себя «дома» в аренде или отеле даже с минимумом своих вещей.", scale: 'AM', questionKey: 'AM2' },
  { id: 15, text: "Мне нравится менять расстановку мебели или детали интерьера по мере изменения жизни.", scale: 'AM', questionKey: 'AM3' },
  { id: 16, text: "Я ценю удобные и мобильные решения (например, складную мебель или легко переносимые предметы), которые не связывают меня навсегда.", scale: 'AM', questionKey: 'AM4' },
  
  // HM - Ежедневные ритуалы
  { id: 17, text: "У меня есть ежедневные домашние ритуалы (кофе, музыка, свеча).", scale: 'HM', questionKey: 'HM1' },
  { id: 18, text: "Я осознанно создаю атмосферу (запах, свет, звуки) каждый день.", scale: 'HM', questionKey: 'HM2' },
  { id: 19, text: "Мне нужны «станции/углы» для занятий (чтение, работа, спорт).", scale: 'HM', questionKey: 'HM3' },
  { id: 20, text: "Готов(а) тратить время на «настройку» дома под себя.", scale: 'HM', questionKey: 'HM4' },
  
  // TU - Комфорт с непредсказуемым
  { id: 21, text: "Меня не смущают временные или незавершённые решения, если они помогают жить сейчас.", scale: 'TU', questionKey: 'TU1' },
  { id: 22, text: "Нормально отношусь к следам жизни и износу — дом не должен быть «музеем».", scale: 'TU', questionKey: 'TU2' },
  { id: 23, text: "Мне комфортно, если дома не всё идеально под контролем — можно отпустить ситуацию.", scale: 'TU', questionKey: 'TU3' },
  { id: 24, text: "Я готов(а) делить жильё с соседями (не близкими людьми), подстраиваясь под общие правила ради плюсов — цены, удобного района или условий.", scale: 'TU', questionKey: 'TU4' },
];

export const scaleNames = {
  ID: 'Самовыражение',
  AT: 'Личные вещи и память',
  CT: 'Порядок и структура',
  AM: 'Лёгкость перемен',
  HM: 'Ежедневные ритуалы',
  TU: 'Комфорт с непредсказуемым'
};

export interface Archetype {
  title: string;
  essence: string;
  strengths: string[];
  risks: string[];
  tryNow: string[];
  watchOut: string[];
  recs: string[];
  checklist: string[];
  experiment: string;
}

export const archetypeDescriptions: Record<string, Archetype> = {
  'ID+CT': {
    title: 'Куратор идентичности',
    essence: 'Вы создаете пространство, которое одновременно отражает вашу личность и поддерживает порядок. Витрины, системы хранения и акценты помогают вам выражать себя через организованную среду.',
    strengths: [
      'Способность создавать уникальное пространство, отражающее личность',
      'Отличные организационные навыки и системное мышление',
      'Умение балансировать эстетику и функциональность',
      'Стремление к качеству и продуманности деталей'
    ],
    risks: [
      'Перфекционизм может замедлять процесс обустройства',
      'Склонность к накоплению "важных" вещей',
      'Сложности с изменениями в уже организованном пространстве',
      'Возможная изоляция от внешнего мира'
    ],
    tryNow: [
      'Создайте "стену вдохновения" с любимыми изображениями и цитатами',
      'Организуйте одну зону по принципу "всё на своих местах"',
      'Добавьте один предмет, который рассказывает вашу историю',
      'Создайте систему хранения для документов и важных бумаг'
    ],
    watchOut: [
      'Не перегружайте пространство деталями',
      'Оставляйте место для спонтанных изменений',
      'Регулярно пересматривайте и обновляйте коллекции',
      'Не забывайте про комфорт в погоне за красотой'
    ],
    recs: [
      'Используйте модульную мебель для гибкости',
      'Создайте "зону перемен" для экспериментов',
      'Документируйте изменения в интерьере',
      'Планируйте пространство с учетом будущих потребностей'
    ],
    checklist: [
      'Система хранения для каждой категории вещей',
      'Витрина или полка для личных коллекций',
      'Организованное рабочее место',
      'Место для хранения документов и важных бумаг',
      'Декоративные элементы, отражающие ваши интересы',
      'Система освещения для разных зон',
      'Место для творчества или хобби'
    ],
    experiment: 'В течение недели каждый день добавляйте или убирайте один предмет в вашем пространстве. Ведите дневник ощущений: как изменения влияют на ваше настроение и продуктивность?'
  },
  'ID+AT': {
    title: 'Коллекционер памяти',
    essence: 'Ваш дом — это музей вашей жизни. Стена памяти, рамки с фотографиями и архив-боксы помогают вам сохранять связь с прошлым и рассказывать свою историю.',
    strengths: [
      'Глубокая эмоциональная связь с пространством',
      'Способность создавать уютную атмосферу',
      'Умение сохранять важные воспоминания',
      'Творческий подход к организации пространства'
    ],
    risks: [
      'Склонность к накоплению вещей с эмоциональной ценностью',
      'Сложности с расставанием с предметами',
      'Возможная перегруженность пространства',
      'Трудности с адаптацией к изменениям'
    ],
    tryNow: [
      'Создайте "стену памяти" с фотографиями и памятными вещами',
      'Организуйте архив важных документов и писем',
      'Создайте уголок для хранения детских вещей или подарков',
      'Начните вести дневник или альбом воспоминаний о доме'
    ],
    watchOut: [
      'Регулярно пересматривайте коллекции и избавляйтесь от лишнего',
      'Не позволяйте вещам управлять пространством',
      'Оставляйте место для новых воспоминаний',
      'Не забывайте про функциональность в погоне за атмосферой'
    ],
    recs: [
      'Используйте системы хранения для организации коллекций',
      'Создайте "ротацию" памятных вещей',
      'Цифруйте важные документы и фотографии',
      'Планируйте пространство с учетом будущих коллекций'
    ],
    checklist: [
      'Стена или полка для фотографий и памятных вещей',
      'Архивные коробки для документов',
      'Место для хранения подарков и сувениров',
      'Альбомы или папки для коллекций',
      'Система хранения для детских вещей',
      'Место для творческих проектов',
      'Уютный уголок для чтения или размышлений'
    ],
    experiment: 'В течение недели каждый день выбирайте один предмет с эмоциональной ценностью и решайте: оставить, подарить или выбросить. Записывайте свои чувства и мысли об этом процессе.'
  },
  'CT+AT': {
    title: 'Стратег контроля',
    essence: 'Вы создаете структурированную среду, которая дает вам чувство контроля. Зонирование, шкафы и контроль света/шума помогают вам чувствовать себя в безопасности.',
    strengths: [
      'Отличные организационные способности',
      'Умение создавать предсказуемую среду',
      'Способность к системному планированию',
      'Внимание к деталям и качеству'
    ],
    risks: [
      'Склонность к чрезмерному контролю',
      'Сложности с адаптацией к изменениям',
      'Возможная ригидность в подходах',
      'Стресс от неожиданных ситуаций'
    ],
    tryNow: [
      'Создайте четкое зонирование пространства',
      'Организуйте систему хранения по категориям',
      'Настройте освещение для разных зон',
      'Создайте "станцию контроля" с календарем и планами'
    ],
    watchOut: [
      'Оставляйте место для спонтанности',
      'Не перегружайте пространство системами',
      'Регулярно пересматривайте и упрощайте',
      'Помните про комфорт и уют'
    ],
    recs: [
      'Используйте модульные системы хранения',
      'Создайте "буферные зоны" для изменений',
      'Планируйте пространство с учетом роста',
      'Включайте элементы неожиданности в дизайн'
    ],
    checklist: [
      'Четкое зонирование всех помещений',
      'Система хранения для каждой категории вещей',
      'Контроль освещения и звука',
      'Организованное рабочее место',
      'Система документооборота',
      'План эвакуации и безопасности',
      'Резервные системы и запасные варианты'
    ],
    experiment: 'В течение недели каждый день вносите одно небольшое изменение в ваше пространство. Наблюдайте, как это влияет на ваше чувство контроля и комфорта.'
  },
  'AM+HM': {
    title: 'Кочующий гнездостроитель',
    essence: 'Вы легко адаптируетесь к новым местам, но при этом создаете уютные ритуалы. Портативные якоря и складная мебель помогают вам чувствовать себя дома везде.',
    strengths: [
      'Высокая адаптивность к изменениям',
      'Способность быстро создавать уют',
      'Мобильность и гибкость',
      'Умение находить красоту в простом'
    ],
    risks: [
      'Склонность к поверхностным связям с местом',
      'Сложности с долгосрочным планированием',
      'Возможная нестабильность',
      'Трудности с глубокими изменениями'
    ],
    tryNow: [
      'Создайте "портативный набор" для быстрого обустройства',
      'Установите ежедневные ритуалы, которые можно переносить',
      'Организуйте мобильное рабочее место',
      'Создайте "якоря стабильности" в новом месте'
    ],
    watchOut: [
      'Не забывайте про долгосрочные цели',
      'Создавайте глубину в отношениях с местом',
      'Планируйте будущее развитие',
      'Не теряйте связь с корнями'
    ],
    recs: [
      'Инвестируйте в качественную мобильную мебель',
      'Создайте цифровые системы для важной информации',
      'Планируйте "якорные точки" в разных местах',
      'Развивайте навыки быстрой адаптации'
    ],
    checklist: [
      'Портативный набор для обустройства',
      'Мобильное рабочее место',
      'Система хранения важных вещей',
      'Цифровые копии важных документов',
      'Список контактов и ресурсов',
      'План действий для переезда',
      'Ритуалы для быстрого "освоения" нового места'
    ],
    experiment: 'В течение недели каждый день меняйте что-то в своем пространстве и наблюдайте, как быстро вы адаптируетесь. Записывайте, что помогает вам чувствовать себя "дома".'
  },
  'HM+ID': {
    title: 'Мастер ритуалов',
    essence: 'Вы создаете пространство, которое поддерживает ваши ежедневные ритуалы и отражает вашу личность. Станции-углы и световые сценарии помогают вам чувствовать себя комфортно.',
    strengths: [
      'Способность создавать осмысленные ритуалы',
      'Глубокое понимание своих потребностей',
      'Умение создавать атмосферу',
      'Внимание к деталям и нюансам'
    ],
    risks: [
      'Склонность к ригидности в ритуалах',
      'Сложности с изменениями в распорядке',
      'Возможная изоляция от внешнего мира',
      'Трудности с адаптацией к новым условиям'
    ],
    tryNow: [
      'Создайте "утреннюю станцию" для начала дня',
      'Организуйте "вечерний уголок" для завершения дня',
      'Настройте освещение для разных настроений',
      'Создайте ритуал для перехода между активностями'
    ],
    watchOut: [
      'Оставляйте место для спонтанности',
      'Не позволяйте ритуалам управлять вами',
      'Регулярно пересматривайте и обновляйте',
      'Помните про гибкость и адаптивность'
    ],
    recs: [
      'Создайте "ритуальные зоны" в разных частях дома',
      'Используйте свет и звук для создания атмосферы',
      'Планируйте пространство с учетом ритмов дня',
      'Включайте элементы неожиданности в ритуалы'
    ],
    checklist: [
      'Утренняя станция для начала дня',
      'Вечерний уголок для завершения дня',
      'Система освещения для разных настроений',
      'Место для медитации или размышлений',
      'Ритуальные предметы и аксессуары',
      'План ритуалов на разные дни недели',
      'Система напоминаний о важных ритуалах'
    ],
    experiment: 'В течение недели каждый день создавайте новый небольшой ритуал и наблюдайте, как он влияет на ваше настроение и продуктивность. Записывайте самые эффективные.'
  },
  'AM+TU': {
    title: 'Гибкий минималист',
    essence: 'Вы цените простоту и гибкость. Многофункциональные предметы и модульность помогают вам адаптироваться к изменениям, не накапливая лишнего.',
    strengths: [
      'Способность к быстрой адаптации',
      'Умение находить красоту в простоте',
      'Эффективное использование пространства',
      'Свобода от материальных привязанностей'
    ],
    risks: [
      'Склонность к поверхностности',
      'Сложности с созданием глубины',
      'Возможная нестабильность',
      'Трудности с долгосрочным планированием'
    ],
    tryNow: [
      'Создайте многофункциональное рабочее место',
      'Организуйте систему "всё в одном"',
      'Начните практику регулярного "расхламления"',
      'Создайте "зону экспериментов" для новых идей'
    ],
    watchOut: [
      'Не теряйте связь с важными вещами',
      'Создавайте глубину в отношениях',
      'Планируйте будущее развитие',
      'Помните про комфорт и уют'
    ],
    recs: [
      'Инвестируйте в качественную многофункциональную мебель',
      'Создайте цифровые системы для важной информации',
      'Планируйте пространство с учетом роста',
      'Развивайте навыки быстрой адаптации'
    ],
    checklist: [
      'Многофункциональная мебель',
      'Система хранения "всё в одном"',
      'Цифровые копии важных документов',
      'План регулярного "расхламления"',
      'Зона для экспериментов и творчества',
      'Система быстрой адаптации к изменениям',
      'Резервные планы на случай изменений'
    ],
    experiment: 'В течение недели каждый день избавляйтесь от одной ненужной вещи и добавляйте одну многофункциональную. Наблюдайте, как это влияет на ваше пространство и настроение.'
  }
};

const mean = (vals: (number | string | undefined)[]) => {
  const nums = vals.map(v => Number(v));               // приведение типов
  const filled = nums.filter(v => Number.isFinite(v));
  if (filled.length === 0) return 0;
  const sum = filled.reduce((a,b)=>a+Number(b), 0);
  return sum / filled.length;
};

export function computeAverages(a: Answers) {
  const avgID = mean([a.ID1,a.ID2,a.ID3,a.ID4]);
  const avgAT = mean([a.AT1,a.AT2,a.AT3,a.AT4]);
  const avgCT = mean([a.CT1,a.CT2,a.CT3,a.CT4]);
  const avgAM = mean([a.AM1,a.AM2,a.AM3,a.AM4]);
  const avgHM = mean([a.HM1,a.HM2,a.HM3,a.HM4]);
  const avgTU = mean([a.TU1,a.TU2,a.TU3,a.TU4]);
  return { avgID, avgAT, avgCT, avgAM, avgHM, avgTU };
}

export function computeTensions(avgs: ReturnType<typeof computeAverages>) {
  const { avgAT, avgAM, avgCT, avgTU } = avgs;
  // КЛЮЧЕВАЯ ПРАВКА: модуль разности
  const T1 = Math.abs(avgAT - avgAM);
  const T2 = Math.abs(avgCT - avgTU);
  return { T1, T2 };
}

export function pickTopScales(avgs: ReturnType<typeof computeAverages>) {
  const entries = Object.entries(avgs) as [keyof typeof avgs, number][];
  const sorted = entries.sort((a,b)=> b[1]-a[1]);
  const [top1, top2] = sorted;
  return { top1: top1[0], top2: top2[0], sorted };
}

export function round2(n: number) {
  return Math.round(n * 100) / 100;
}

export function calculateResults(answers: Record<number, number>): TestResult {
  // Преобразуем старый формат ответов в новый формат
  const newAnswers: Partial<Answers> = {};
  
  questions.forEach(question => {
    const answer = answers[question.id];
    if (answer) {
      newAnswers[question.questionKey] = answer;
    }
  });

  // Вычисляем средние
  const avgs = computeAverages(newAnswers as Answers);
  
  // Вычисляем напряжения
  const tensions = computeTensions(avgs);
  
  // Находим топ-2 шкалы
  const { top1, top2 } = pickTopScales(avgs);
  const diff = avgs[top1] - avgs[top2];

  // Определяем архетипы
  const archetypes: string[] = [];
  const descriptions: string[] = [];

  // Пытаемся найти архетип по комбинации топ-2 шкал
  let archetype = getArchetype(top1, top2);
  
  if (!archetype) {
    // Если не нашли, пробуем обратную комбинацию
    archetype = getArchetype(top2, top1);
  }

  if (archetype) {
    archetypes.push(archetype.title);
    descriptions.push(archetype.essence);
    
    // Если разница между топ-1 и топ-2 меньше 0.2, показываем оба архетипа
    if (diff < 0.2) {
      const archetype2 = getArchetype(top2, top1);
      if (archetype2 && archetype2.title !== archetype.title) {
        archetypes.push(archetype2.title);
        descriptions.push(archetype2.essence);
      }
    }
  } else {
    // Fallback: если не нашли архетип, показываем советы по топ-шкале
    const topScaleName = scaleNames[top1 as keyof typeof scaleNames];
    archetypes.push(`Рекомендации по шкале "${topScaleName}"`);
    descriptions.push(`Ваша ведущая шкала - "${topScaleName}". Обратите внимание на развитие этой области в обустройстве дома.`);
  }

  return {
    scores: {
      ID: round2(avgs.avgID),
      AT: round2(avgs.avgAT),
      CT: round2(avgs.avgCT),
      AM: round2(avgs.avgAM),
      HM: round2(avgs.avgHM),
      TU: round2(avgs.avgTU),
    },
    tensions: {
      T1: round2(tensions.T1),
      T2: round2(tensions.T2),
    },
    archetypes,
    descriptions,
    archetypeData: archetype || undefined
  };
}

function getArchetype(scale1: string, scale2: string): Archetype | null {
  const combination = `${scale1}+${scale2}`;
  const reverseCombination = `${scale2}+${scale1}`;
  
  if (archetypeDescriptions[combination]) {
    return archetypeDescriptions[combination];
  }
  
  if (archetypeDescriptions[reverseCombination]) {
    return archetypeDescriptions[reverseCombination];
  }
  
  return null;
}